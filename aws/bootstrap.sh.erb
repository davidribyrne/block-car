#!/bin/bash -x
apt-get update
apt-get -y install python-pip jq
pip install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-1.4-8.tar.gz
pip install awscli

STACK=<%=stack_name%>

function meta() {
  cfn-get-metadata -s ${STACK} -r WebServer -k "$1"
}

function server_cert() {
  aws iam get-server-certificate --server-certificate-name "$1" | jq -r ".ServerCertificate.$2"
}

CHEF_VERSION=12.7.2
RUN_LIST='recipe[cdo-apps]'
BRANCH=<%=branch%>
FIRST_BOOT=/etc/chef/first-boot.json

CERT=$(server_cert $(meta Certificate.Name) CertificateBody)
CHAIN=$(server_cert $(meta Certificates.PegasusName) CertificateChain)
KEY=$(meta Certificates.Key)

jq "." <<JSON > ${FIRST_BOOT}
{
  "cdo-secrets": {
    "override_dashboard": "dashboard-<%=subdomain%>",
    "override_pegasus": "pegasus-<%=subdomain%>"
  },
  "cdo-nginx": {
    "ssl_cert": {
      "content": "${CERT}"
    },
    "ssl_chain": {
      "content": "${CHAIN}"
    },
    "ssl_key": {
      "content": "${KEY}"
    }
  },
  "omnibus_updater": {
    "version": "${CHEF_VERSION}"
  },
  "cdo-repository": {
    "branch": "${BRANCH}"
  },
  "run_list": ["${RUN_LIST}"]
}
JSON

sudo -u ubuntu bash -c "curl https://s3.amazonaws.com/cdo-dist/cdo-bootstrap.sh | sudo bash -s -- <%=local_mode ? '-z' : ''%> -b ${BRANCH} -r \"${RUN_LIST}\""

cfn-signal -e $? --stack ${STACK} --resource WebServer --region <%=region%>
