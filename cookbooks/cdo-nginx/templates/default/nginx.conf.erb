user www-data;
worker_processes auto;
pid /run/nginx.pid;

events {
  worker_connections 1024;
  use epoll;
}

http {
  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  types_hash_max_size 2048;

  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  access_log /var/log/nginx/access.log;
  error_log /var/log/nginx/error.log;
  proxy_redirect off;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  client_max_body_size 4G;
  keepalive_timeout 30;
  server_names_hash_bucket_size 128;

  server {
    listen <%= node['cdo-apps']['dashboard']['port'] %> default deferred;
    server_name dashboard_proxy;
    location / {
      proxy_pass http://unix:<%= @run_dir %>/dashboard.sock;
      proxy_set_header Host $http_host;
    }
  }
  server {
    listen <%= node['cdo-apps']['pegasus']['port'] %> default deferred;
    server_name pegasus_proxy;
    location / {
      proxy_pass http://unix:<%= @run_dir %>/pegasus.sock;
      proxy_set_header Host $http_host;
    }
  }
  server {
    server_name <%=node['cdo-secrets']['override_pegasus'] || 'dashboard_ssl_proxy'%>;
    listen 443 ssl;
    <%= @ssl_key = @pegasus_ssl_key; @ssl_cert = @pegasus_ssl_cert; render 'nginx.erb', cookbook: 'ssl_certificate' %>
    location / {
      # Pass the request on to Varnish.
      proxy_pass  http://127.0.0.1;
      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-Proto https;
    }
  }
  server {
    server_name <%=node['cdo-secrets']['override_dashboard'] || 'dashboard_ssl_proxy'%>;
    listen 443 ssl;
    <%= @ssl_key = @dashboard_ssl_key; @ssl_cert = @dashboard_ssl_cert; render 'nginx.erb', cookbook: 'ssl_certificate' %>
    location / {
      # Pass the request on to Varnish.
      proxy_pass  http://127.0.0.1;
      proxy_set_header Host $http_host;
      proxy_set_header X-Forwarded-Proto https;
    }
  }
}
